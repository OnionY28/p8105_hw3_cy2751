---
title: "p8105_hw3_cy2752"
author: "Congyu Yang"
date: "2024-10-09"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      fig.width = 8, 
                      fig.height = 6,
                      out.width = "90%")
library(tidyverse)
library(p8105.datasets)
library(ggridges)
library(patchwork)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```
## Problem 1
```{r}
data("ny_noaa")

(ny_noaa <- 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"),sep = "-") %>% 
  mutate(tmax = as.numeric(tmax),
         tmin = as.numeric(tmin),
         year = as.numeric(year),
         month = as.numeric(month),
         day = as.numeric(day)))

ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))
```
This `ny_noaa` dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. It includes variables `id` which is the weather station id, `date` of observation, precipitation in tenths of mm, snowfall in mm, `snwd` representing snow_depth in mm, and min and max temperature in tenths of degrees C.\

We clean the data by creating separate variables for `year`, `month`, and `day` and converting them and `tmax` and `tmin` all to numeric variables. \
We find that 0 is the most commonly observed value for snowfall by using `arrange()` function. This is because in NY, it is not likely to snow.\
The second most commonly observed value is NA, indicating missing values. We can see this dataset miss huge amount of data. Other common values are 25, 31, 51 and 76, suggesting that snowfall is originally recorded in fractions of an inch and converted to mm.

```{r}
ny_noaa %>% 
  filter(month == 1 | month == 7) %>% 
  group_by(id,month,year) %>% 
  summarize(avg_tmax = mean(tmax,na.rm = T)) %>% 
  ggplot(aes(x = year, y = avg_tmax,group = id)) +
  geom_point() + geom_line()+
  facet_grid(. ~ month)+
  labs(title = "Mean monthly temperature for each station across years for January and July")
```
As we can see, the average temperature in January is lower than that in July for all stations and among all years, which is under expectation. And all stations follow almost the same trend in the same month. There are truly some outliers, we can see the January in 1982 and 2005, it is much colder than usual; July in 1988 is also unexpected cold.

```{r}
tmin_tmax_hex <- ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax))+
  geom_hex()

snow_ridge <- ny_noaa %>% 
  filter(0<snow & snow < 100) %>% 
  group_by(year) %>% 
  ggplot(aes(x = snow,y = as.factor(year)))+
  geom_density_ridges()

tmin_tmax_hex + snow_ridge
```
Here are the hex and ridge plot:\
For the hex plot, the majority of the data are centered in the middle for the distribution(which is shown as the lighter color). In the relatively rare cases, `tmax` is less than `tmin`, which might be caused by original data error.\
For the ridge plot, the distribution of each year snowfall are all multi-peak.\
For most of the stations, we see the snow is between 0 and 35 mm in a year.\
Then there is a another group of stations that see about 45 mm of snow, and another group that sees nearly 75 mm.\

## Problem 2

```{r}
participant_data <- 
  read_csv("hw3_data/nhanes_covar.csv",skip = 4,col_names = T, na = "NA") %>% 
  janitor::clean_names()%>%
  filter(!is.na(bmi) & !is.na(education)) %>% 
  filter(age >= 21) %>% 
  mutate(sex = as.factor(case_match(sex,1 ~ "male", 2 ~ "female")),
         education = as.factor(case_match(education,
                                1 ~ "Less than high school",
                                2 ~ "High school equivalent",
                                3 ~ "More than high school"))) %>% 
  mutate(sex = factor(sex,levels = c("male","female")),
         education = factor(education,levels = c("Less than high school",
                                       "High school equivalent",
                                       "More than high school")))

accelerometer_data <- 
  read_csv("hw3_data/nhanes_accel.csv")%>% 
  janitor::clean_names()%>%
  pivot_longer(cols = min1:min1440,
               names_to = "min",
               values_to = "mims",
               names_prefix = "min") %>% 
  mutate(min = as.integer(min))

joint_acc_df <- left_join(participant_data,accelerometer_data,by = "seqn")

participant_data %>% 
  janitor::tabyl(education,sex) %>% 
  knitr::kable()
```


```{r}
participant_data %>% 
  ggplot(aes(x = education, y = age,fill = sex))+
  geom_boxplot(alpha = 0.3)
```
*** Missing Comment ***

```{r}
joint_acc_df %>% group_by(seqn,age,sex,education) %>% 
  summarize(total = sum(mims))%>% 
  ggplot(aes(x = age,y = total,color = sex))+
  geom_point(alpha = 0.3)+
  facet_grid(.~education)+
  geom_smooth(se = F)
```
*** Missing Comment ***

```{r fig.width=8, fig.height=6}
joint_acc_df %>% group_by(min,education,sex) %>% 
  summarize(mean_mims = mean(mims)) %>% 
  ggplot(aes(x = min,y = mean_mims,color = sex))+
  geom_point(alpha = 0.3)+
  geom_smooth(se = F)+
  facet_grid(education ~ .)
```

*** Missing Comment ***

## Problem 3

```{r}
citi_jan_2020 <- read_csv("hw3_data/citibike/Jan 2020 Citi.csv") %>% 
  janitor::clean_names()%>%
  mutate(date = "jan_2020",
    rideable_type = as.factor(rideable_type),
         weekdays = as.factor(weekdays),
         member_casual = as.factor(member_casual)) %>% 
  select(date,everything())

citi_jan_2024 <- read_csv("hw3_data/citibike/Jan 2024 Citi.csv") %>% 
  janitor::clean_names()%>%
  mutate(date = "jan_2024",
    rideable_type = as.factor(rideable_type),
         weekdays = as.factor(weekdays),
         member_casual = as.factor(member_casual))%>% 
  select(date,everything())

citi_jul_2020 <- read_csv("hw3_data/citibike/July 2020 Citi.csv") %>% 
  janitor::clean_names()%>%
  mutate(date = "jul_2020",
    rideable_type = as.factor(rideable_type),
         weekdays = as.factor(weekdays),
         member_casual = as.factor(member_casual)) %>% 
  select(date,everything())

citi_jul_2024 <- read_csv("hw3_data/citibike/July 2024 Citi.csv") %>% 
  janitor::clean_names()%>%
  mutate(date = "jul_2024",
    rideable_type = as.factor(rideable_type),
         weekdays = as.factor(weekdays),
         member_casual = as.factor(member_casual))%>% 
  select(date,everything())

citi_all <- bind_rows(citi_jan_2020,citi_jan_2024,citi_jul_2020,
                      citi_jul_2024)
```
*** describe the resulting dataset ***

```{r}
citi_all %>% group_by(date,member_casual) %>% 
  summarize(frcy = n()) %>% 
  pivot_wider(names_from = "member_casual",
              values_from = "frcy") %>% 
  knitr::kable()
```


```{r}
citi_jul_2024 %>% 
  group_by(start_station_name) %>% 
  summarise(frcy = n()) %>% 
  arrange(desc(frcy)) %>% 
  head(5) %>% 
  knitr::kable()
```



```{r}
citi_all %>% separate(date,into = c("month","year"),sep = "_")%>% 
  mutate(weekdays = factor(weekdays,
                           levels = c("Monday","Tuesday","Wednesday",
                              "Thursday","Friday","Saturday","Sunday"))) %>% 
  group_by(year,month,weekdays) %>% 
  summarise(median_duration = median(duration)) %>% 
  ggplot(aes(x = weekdays, y = median_duration,color = year,group = year))+
  geom_point()+ geom_line()+
  facet_grid(.~month,labeller = as_labeller(c("jan" = "January","jul" = "July")))+
  theme(axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
        legend.position = "bottom")
  
```
*** Comment ***

```{r}
citi_all %>% filter(date == "jan_2024" | date == "jul_2024") %>% 
  group_by(date,rideable_type,member_casual) %>% 
  ggplot(aes(x = date,y = duration,fill = rideable_type))+
  geom_boxplot()+
  facet_grid(. ~ member_casual)
```

*** Comment ***